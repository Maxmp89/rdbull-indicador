<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>📈 Indicador RDBULL CALL (EMA + RSI)</title>
    <style>
        body { background-color: #111; color: white; font-family: Arial, sans-serif; }
        h1 { color: gold; }
        .status {
            border: 1px solid gray; padding: 15px; margin-top: 20px;
            background-color: #000; color: lime; height: 200px;
            overflow-y: auto; white-space: pre-line;
        }
        li { margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>✅ Indicador <strong>RDBULL CALL (EMA + RSI)</strong></h1>
    <p>Exibe sinais de compra com base em:</p>
    <ul>
        <li>📌 Preço acima da EMA 50</li>
        <li>📌 RSI(14) acima de 50</li>
        <li>📌 Candle anterior vermelho, atual verde</li>
    </ul>

    <p>Conectando ao WebSocket da Deriv e gerando sinais abaixo...</p>
    <div class="status" id="log"></div>

    <script>
        const log = (msg, error=false) => {
            const el = document.getElementById("log");
            el.innerHTML += (error ? "❌ " : "✔ ") + msg + "\\n";
            el.scrollTop = el.scrollHeight;
        };

        const app_id = "87915";
        const ws = new WebSocket(`wss://ws.deriv.com/websockets/v3?app_id=${app_id}`);

        ws.onopen = () => {
            log("Conectado com sucesso ao WebSocket da Deriv.");
            ws.send(JSON.stringify({
                ticks_history: "RDBULL",
                adjust_start_time: 1,
                count: 100,
                style: "candles",
                granularity: 60,
                subscribe: 1
            }));
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.msg_type === "history") {
                const candles = data.history.candles;
                if (candles.length < 50) return;

                const closes = candles.map(c => parseFloat(c.close));
                const rsi = (arr, period = 14) => {
                    let gains = 0, losses = 0;
                    for (let i = 1; i <= period; i++) {
                        let change = arr[i] - arr[i - 1];
                        if (change > 0) gains += change;
                        else losses -= change;
                    }
                    const avgGain = gains / period;
                    const avgLoss = losses / period || 1;
                    const rs = avgGain / avgLoss;
                    return 100 - (100 / (1 + rs));
                };

                const ema = (arr, period = 50) => {
                    const k = 2 / (period + 1);
                    return arr.reduce((acc, val, i) => {
                        if (i === 0) return val;
                        return val * k + acc * (1 - k);
                    });
                };

                const rsi14 = rsi(closes.slice(-15));
                const ema50 = ema(closes);
                const prev = candles.at(-2), curr = candles.at(-1);

                if (
                    parseFloat(curr.close) > ema50 &&
                    rsi14 > 50 &&
                    parseFloat(prev.close) < parseFloat(prev.open) &&
                    parseFloat(curr.close) > parseFloat(curr.open)
                ) {
                    log("🔼 Sinal de COMPRA confirmado! 📈");
                } else {
                    log("Aguardando condições...");
                }
            }
        };

        ws.onerror = (e) => log("Erro de conexão: " + e.message, true);
        ws.onclose = () => log("Conexão fechada.", true);
    </script>
</body>
</html>
